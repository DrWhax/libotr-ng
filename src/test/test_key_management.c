#include "../key_management.h"

void
test_derive_ratchet_keys ()
{
  shared_secret_t shared = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  };

  ratchet_t ratchet;
  derive_ratchet_keys (&ratchet, shared);

  root_key_t expected_root_key;

  gcry_md_hd_t sha3_512;
  uint8_t magic[3] = { 0x01, 0x02, 0x03 };
  gcry_md_open (&sha3_512, GCRY_MD_SHA3_512, GCRY_MD_FLAG_SECURE);
  gcry_md_write (sha3_512, &magic[0], 1);
  gcry_md_write (sha3_512, shared, sizeof (shared_secret_t));
  memcpy (expected_root_key, gcry_md_read (sha3_512, 0), sizeof (root_key_t));
  gcry_md_close (sha3_512);

  otrv4_assert_cmpmem (expected_root_key, ratchet.root_key,
		       sizeof (root_key_t));
}
