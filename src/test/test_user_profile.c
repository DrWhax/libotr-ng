#include <glib.h>
#include <time.h>
#include <string.h>

#include "../user_profile.h"

void
test_user_profile_create() {
  const char *handler = "handler@service.net";
  
  user_profile_t *profile = user_profile_get_or_create_for(handler);

  g_assert_cmpint(profile->pub_key->type, ==, 16);
  g_assert_cmpuint(profile->num_versions, ==, 1);
  //TODO: assert versions array
  g_assert_cmpint(profile->expires, >=, time(NULL) + 2592000);
  //g_assert_cmp(profile->signature, !=, NULL);

  user_profile_free(profile);
}

void
test_user_profile_serializes() {
  user_profile_t *profile = user_profile_get_or_create_for("h@c.com");
  profile->expires = 15;
  uint8_t serialized[500] = { 0 };

  int writen = user_profile_serialize(serialized, profile);

  char expected[] = {
    0x0, 0x10, // pub key - type
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,// C
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,// D
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,// H
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x01, // number of versions supported
    0x04, // versions supported
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0F, // expires
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, // signature
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, // transitional signature
  };
  int expected_size = sizeof(expected);
  g_assert_cmpint(writen, ==, expected_size);
  int comp = memcmp(serialized, expected, expected_size);
  g_assert_cmpint(comp, ==, 0);
}

int
main(int argc, char **argv) {
  g_test_init(&argc, &argv, NULL);

  g_test_add_func("/user_profile_create", test_user_profile_create);
  g_test_add_func("/user_profile_serialize", test_user_profile_serializes);

  return g_test_run();
}
